<!doctype html>
<html lang="en" class="dark">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Wandering1337's stock composer for x.com</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  /* small local tweaks */
  .card { background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent); }
</style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen flex flex-col">
<div class="container mx-auto max-w-2xl p-6 flex-1">
  <!-- header -->
  <header class="flex items-start justify-between gap-4 mb-6">
    <div>
      <h1 class="text-3xl font-extrabold">Market Thing</h1>
      <p class="text-sm text-slate-400">@wandering1337 on all platforms</p>
    </div>
    <img src="https://pbs.twimg.com/profile_images/1984517737939632128/EMjLrSRa_400x400.jpg" alt="decor"
      class="w-16 h-16 rounded-lg object-cover border border-slate-700 shadow-md" />
  </header>

  <!-- main card -->
  <main class="card border border-slate-700 rounded-2xl p-5 shadow-lg">
    <div class="grid grid-cols-2 gap-6">
      <!-- left section -->
      <section class="col-span-2 md:col-span-1">
        <label class="text-xs text-slate-400">Asset type</label>
        <select id="assetType" class="mt-2 w-full rounded-md p-2 bg-slate-800 border border-slate-700">
          <option value="crypto">Crypto</option>
          <option value="stock">Stock</option>
        </select>

        <label class="text-xs text-slate-400 mt-3 block">Symbol</label>
        <input id="symbol" placeholder="BTC, ETH, AAPL" class="mt-2 w-full rounded-md p-2 bg-slate-800 border border-slate-700" />

        <div class="mt-3">
          <label class="text-xs text-slate-400">Proxy (optional, helps with CORS)</label>
          <input id="proxyUrl" placeholder="https://api.allorigins.win/raw?url=" class="mt-2 w-full rounded-md p-2 bg-slate-800 border border-slate-700" />
          <label class="mt-2 inline-flex items-center gap-2 text-sm text-slate-400">
            <input type="checkbox" id="useProxy" /> Use proxy
          </label>
        </div>

        <div class="mt-4 flex gap-2">
          <button id="fetchBtn" class="flex-1 bg-indigo-600 hover:bg-indigo-700 rounded-md py-2 font-semibold">Fetch price</button>
          <button id="clearBtn" class="bg-slate-700 hover:bg-slate-600 rounded-md px-4">Clear</button>
        </div>

        <div id="priceBox" class="mt-4 p-3 rounded-md border border-slate-700 bg-slate-900 text-center">
          <div id="priceDisplay" class="text-xl font-bold">—</div>
          <div id="priceChange" class="text-sm text-slate-400 mt-1">No data</div>
          <div id="prevDisplay" class="text-xs text-slate-500 mt-1">Previous stored: —</div>
        </div>

        <div class="mt-3 text-xs text-slate-400">
          If you get <strong>"Failed to fetch"</strong>, enable proxy and set the proxy URL to
          <code>https://api.allorigins.win/raw?url=</code> then retry.
        </div>
      </section>

      <!-- right section -->
      <section class="col-span-2 md:col-span-1">
        <label class="text-xs text-slate-400">Tweet template</label>
        <textarea id="tweetTpl" rows="4" class="mt-2 w-full rounded-md p-2 bg-slate-800 border border-slate-700">$ASSET $DIRECTION — $PRICE ($CHANGE)</textarea>

        <div class="mt-3 flex gap-2">
          <button id="buildBtn" class="flex-1 bg-emerald-600 hover:bg-emerald-700 rounded-md py-2 font-semibold">Build Tweet</button>
          <button id="copyBtn" class="bg-slate-700 rounded-md px-4">Copy</button>
        </div>

        <textarea id="tweetOut" readonly rows="3" class="mt-3 w-full rounded-md p-2 bg-slate-900 border border-slate-700"></textarea>

        <div class="mt-3 flex gap-2">
          <button id="postBtn" class="flex-1 bg-black hover:bg-slate-900 text-white rounded-md py-2">Open on X</button>
          <button id="mockBtn" class="bg-slate-700 rounded-md px-4">Mock</button>
        </div>

        <div id="status" class="mt-3 text-sm text-slate-400">Status: idle</div>
        <div id="errorBox" class="mt-2 text-sm text-red-400 hidden"></div>
      </section>
    </div>

    <footer class="mt-6 text-center text-xs text-slate-500">
      need automation? ask for OAuth/X integration
    </footer>
  </main>
</div>

<script>
const $ = id => document.getElementById(id);

// --- Status/Error ---
function setStatus(s){ $('status').textContent = 'Status: ' + s; }
function showError(msg){
  const e = $('errorBox');
  e.textContent = msg;
  e.classList.remove('hidden');
  setTimeout(() => e.classList.add('hidden'), 6000);
}

// --- LocalStorage ---
function savePrev(sym, price){ try{ localStorage.setItem('last_price_'+sym, price); }catch{} }
function getPrev(sym){ try{ const v=localStorage.getItem('last_price_'+sym); return v!==null ? parseFloat(v) : null; }catch{return null} }

// --- Fetch wrapper with fallback ---
async function fetchJsonWithFallback(url, proxyOpt){
  try { const res = await fetch(url); if(!res.ok) throw new Error('HTTP '+res.status); return await res.json(); }
  catch(err){
    const proxies = proxyOpt?.trim() ? [proxyOpt.trim()] : [];
    proxies.push('https://api.allorigins.win/raw?url=');
    proxies.push('https://api.codetabs.cc/v1/proxy?quest=');
    for(let p of proxies){
      try{
        const r = await fetch(p + encodeURIComponent(url));
        if(!r.ok) throw new Error('Proxy HTTP '+r.status);
        return await r.json();
      }catch{}
    }
    throw new Error('Failed to fetch. ' + err.message);
  }
}

// --- Data fetchers ---
async function fetchCryptoPrice(sym, proxy){
  const idMap = { btc:'bitcoin', eth:'ethereum' };
  const id = idMap[sym.toLowerCase()] || sym.toLowerCase();
  const url = `https://api.coingecko.com/api/v3/simple/price?ids=${id}&vs_currencies=usd&include_24hr_change=true`;
  const json = await fetchJsonWithFallback(url, proxy);
  const data = json[id]; if(!data?.usd) throw new Error('Coin not found');
  return { price:Number(data.usd), changePct: data.usd_24h_change??null };
}

async function fetchStockPrice(sym, proxy){
  const url = `https://query1.finance.yahoo.com/v8/finance/chart/${sym}?range=1d&interval=1m`;
  const json = await fetchJsonWithFallback(url, proxy);
  const res = json.chart?.result?.[0]; if(!res) throw new Error('Stock not found');
  const meta = res.meta || {};
  const price = meta.regularMarketPrice ?? res.indicators?.quote?.[0]?.close?.slice(-1)[0];
  const prev = meta.previousClose ?? null;
  const changePct = (price!==null && prev!==null) ? ((price-prev)/prev*100) : null;
  return { price:Number(price), prevClose:Number(prev), changePct };
}

// --- UI updates ---
function updatePriceUI(sym, price, prev, changePct, isCrypto, prevClose=null){
  const absChange = prev!==null ? (price-prev).toFixed(2) : '—';
  const changeText = (changePct!==null) ? (changePct>=0?'+':'')+changePct.toFixed(2)+'%' : 'N/A';
  $('priceDisplay').textContent = isCrypto ?
    '$'+Number(price).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:8}) :
    '$'+Number(price).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});
  $('priceChange').textContent = isCrypto ?
    (prev!==null ? `${absChange} (${changeText})` : `24h ${changeText}`) :
    `${absChange} (${changeText}) vs prev close $${prevClose?.toFixed(2)||'—'}`;
  $('prevDisplay').textContent = 'Previous stored: ' + (prev!==null ? ('$'+prev.toFixed(2)) : '—');
  $('priceDisplay').className = price > (prev ?? prevClose ?? 0) ? 'text-emerald-400 font-bold' : 'text-red-400 font-bold';
}

// --- Fetch button ---
async function doFetch(){
  setStatus('Fetching');
  $('priceDisplay').textContent = '...'; $('priceChange').textContent = '';
  try{
    const sym = ($('symbol').value||'').trim();
    if(!sym) { showError('Enter a symbol'); setStatus('idle'); return; }
    const proxy = $('useProxy').checked ? ($('proxyUrl').value||'').trim() : '';
    if($('assetType').value==='crypto'){
      const {price, changePct} = await fetchCryptoPrice(sym, proxy);
      const prev = getPrev(sym.toUpperCase())??getPrev(sym.toLowerCase());
      savePrev(sym.toUpperCase(), price);
      updatePriceUI(sym, price, prev, changePct, true);
    } else {
      const {price, prevClose, changePct} = await fetchStockPrice(sym, proxy);
      savePrev(sym.toUpperCase(), price);
      updatePriceUI(sym, price, getPrev(sym.toUpperCase()), changePct, false, prevClose);
    }
    setStatus('Fetched');
  }catch(err){ console.error(err); showError(err.message||'Fetch failed'); setStatus('error'); }
}

// --- Tweet builder ---
function buildTweet(){
  const tpl = ($('tweetTpl').value||'').trim();
  const sym = ($('symbol').value||'').trim().toUpperCase();
  if(!sym) return showError('Symbol required');
  const priceText = $('priceDisplay').textContent||''; if(!priceText||priceText==='...') return showError('Fetch price first');
  const price = priceText.match(/\$([0-9.,]+)/)?.[1] || '';
  const change = $('priceChange').textContent||'';
  const direction = (change && change.includes('-')) ? 'gone down' : 'gone up';
  $('tweetOut').value = tpl.replace(/\$ASSET/g,sym).replace(/\$DIRECTION/g,direction).replace(/\$PRICE/g,price?'$'+price:'').replace(/\$CHANGE/g,change);
  setStatus('Built');
}

// --- Copy tweet ---
async function copyTweet(){
  const txt = $('tweetOut').value||''; if(!txt) return showError('Nothing to copy');
  setStatus('Copying');
  try{ if(navigator.clipboard) { await navigator.clipboard.writeText(txt); setStatus('Copied'); return; } }catch{}
  const ta = document.createElement('textarea'); ta.value = txt; ta.style.position='fixed'; ta.style.left='-9999px'; document.body.appendChild(ta);
  ta.select(); document.execCommand('copy'); document.body.removeChild(ta); setStatus('Copied (fallback)');
}

// --- Event listeners ---
$('fetchBtn').addEventListener('click', doFetch);
$('clearBtn').addEventListener('click', ()=>{
  const s=($('symbol').value||'').trim();
  if(s){ localStorage.removeItem('last_price_'+s); $('priceDisplay').textContent='—'; $('priceChange').textContent=''; $('prevDisplay').textContent='Previous stored: —'; setStatus('Cleared'); }
});
$('buildBtn').addEventListener('click', buildTweet);
$('copyBtn').addEventListener('click', copyTweet);
$('postBtn').addEventListener('click', ()=>{
  const t=$('tweetOut').value||''; if(!t) return showError('Build first');
  window.open('https://x.com/intent/tweet?text='+encodeURIComponent(t),'_blank');
});
$('mockBtn').addEventListener('click', ()=>{
  $('symbol').value='MOCK'; $('assetType').value='crypto';
  $('priceDisplay').textContent='$123.45'; $('priceChange').textContent='+1.23%'; $('prevDisplay').textContent='Previous stored: $122.00';
  $('tweetOut').value='$MOCK up — $123.45 (+1.23%)'; setStatus('Mock loaded');
});

console.log('Market Watch loaded. Use proxy if fetch fails due to CORS.');
</script>
</body>
</html>
